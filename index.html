<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Onmyoji ‚Äì Playtest</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      

      font-family: system-ui, sans-serif;
      padding: 16px;
      background: #f4f4f4;
    }

    h1, h2 {
      margin-top: 0;
    }

    button {
      padding: 10px 16px;
      margin: 8px 0;
      font-size: 16px;
      width: 100%;
    }

    .panel {
      background: white;
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 6px;
    }

    .hidden {
      display: none;
    }

    pre {
      background: #eee;
      padding: 8px;
      overflow-x: auto;
    }

    .encyclopedia {
  position: fixed;
  top: 10%;
  right: 5%;
  width: 90%;
  max-width: 420px;
  max-height: 80%;
  background: white;
  border-radius: 8px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.25);
  padding: 12px;
  overflow-y: auto;
  z-index: 1000;
}

.encyclopedia-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.encyclopedia-entry {
  border-bottom: 1px solid #ddd;
  padding: 6px 0;
  font-size: 14px;
}

  </style>
</head>

<body>
<!-- DIFFICULTY SELECT -->
<div class="panel" id="difficultyPanel">
  <h2>Select Difficulty</h2>

  <button data-difficulty="easy">Easy</button>
  <button data-difficulty="normal">Normal</button>
  <button data-difficulty="hard">Hard</button>

  
</div>

 <div id="gamePanel" class="hidden"> 
  <h1>Onmyoji ‚Äì Playtest</h1>

  <!-- Party HP --> 
  <div class="panel">
    <h2>Party HP</h2>
    <div id="partyHP"></div>
  </div>

  <!-- ROUND INFO -->
  <div class="panel">
    <h2>Round</h2>
    <div id="roundInfo"></div>
  </div>

  <!-- CLUES -->
  <div class="panel">
    <h2>Clues</h2>
    <div id="clueInfo"></div>
  </div>

  <!-- YOKAI ENCYCLOPEDIA TOGGLE -->
<div class="panel">
  <button id="toggleEncyclopediaBtn">
    üìñ Yokai Encyclopedia
  </button>
</div>

<!-- ENCYCLOPEDIA OVERLAY -->
<div id="encyclopediaOverlay" class="encyclopedia hidden">
  <div class="encyclopedia-header">
    <strong>Yokai Encyclopedia</strong>
    <button id="closeEncyclopediaBtn">‚úï</button>
  </div>

  <div id="encyclopedia-list"></div>
</div>

  <!-- SPELL SELECTION -->
  <div class="panel">
    <h2>Spell Selection</h2>
    <div id="spellHands"></div>
    <button id="submitSpellsBtn">Submit Spells</button>
  </div>

  <!-- COMBAT RESULTS -->
  <div class="panel">
  <button id="toggleCombatBtn">‚öîÔ∏è Combat Results</button>
</div>

<div id="combatOverlay" class="encyclopedia hidden">
  <div class="encyclopedia-header">
    <strong>Combat Results</strong>
    <button id="closeCombatBtn">‚úï</button>
  </div>

  <pre id="combatResults"></pre>
</div>
  <div class="panel hidden" id="nextRoundPanel">
    <button id="nextRoundBtn">Next Round</button>
</div>


  
 </div>

  <!-- GUARDIAN SELECTION -->
  <div class="panel hidden" id="guardianPanel">
    <h2>Summon a Guardian</h2>
  
    <button data-guardian="Genbu">Genbu ‚Äì +1 Defense Die (Permanent)</button>
    <button data-guardian="Byakko">Byakko ‚Äì +1 Attack Die (Permanent)</button>
    <button data-guardian="Suzaku">Suzaku ‚Äì Disable Defense Negation</button>
    <button data-guardian="Seiryu">Seiryu ‚Äì Gain Random Resources</button>
  </div>
  <!-- SHOP PANEL -->
  <div class="panel hidden" id="shopPanel">
    <h2>Spell Shop</h2>
  
    <div id="shopResources"></div>
    <div id="shopSpells"></div>
  
    <button id="closeShopBtn">Start Next Day</button>
  </div>

  <!-- GAME OVER -->
  <div class="panel hidden" id="gameOverPanel">
    <h2 id="gameOverTitle"></h2>
    <p id="gameOverText"></p>
    <button id="restartGameBtn">Restart Game</button>
  </div>

  
  <!-- MAIN SCRIPT -->
  <script type="module">
    
  
    import { DIFFICULTIES } from "./logic/difficulty.js";
    import { startRound, submitSpells } from "./logic/roundFlow.js";
    import { gameState, initGame } from "./gameState.js";
    import { RULES } from "./logic/rulesets.js";
    import { renderEncyclopedia } from "./logic/renderEncyclopedia.js";
    import { initPlayerEncyclopedia } from "./data/playerEncyclopedia.js";
    import { applyGuardian } from "./logic/guardians.js";
    import { getShopSpells } from "./logic/shop.js";
    import { advanceDay } from "./gameState.js";






    const difficultyPanel = document.getElementById("difficultyPanel");
    const gamePanel = document.getElementById("gamePanel");

difficultyPanel
  .querySelectorAll("button")
  .forEach(btn => {
    btn.onclick = async () => {
      const key = btn.dataset.difficulty;
      const difficulty = DIFFICULTIES[key];

      difficultyPanel.classList.add("hidden");
      gamePanel.classList.remove("hidden");

      initGame(4, {
        partyHP: difficulty.partyHP,
        maxDays: difficulty.maxDays,
      });

  await initPlayerEncyclopedia();   
  await startRound();
  renderRound();
  await renderEncyclopedia();      
 };
});

    
    const roundInfo = document.getElementById("roundInfo");
    const clueInfo = document.getElementById("clueInfo");
    const submitBtn = document.getElementById("submitSpellsBtn");
    const combatResults = document.getElementById("combatResults");
    const nextRoundBtn = document.getElementById("nextRoundBtn");

    
  /**  (async function bootGame() {
      initGame(4);
      await startRound();
      renderRound();
    })();
**/


    const toggleBtn = document.getElementById("toggleEncyclopediaBtn");
    const closeBtn = document.getElementById("closeEncyclopediaBtn");
    const overlay = document.getElementById("encyclopediaOverlay");
    const combatOverlay = document.getElementById("combatOverlay");
    const toggleCombatBtn = document.getElementById("toggleCombatBtn");
    const closeCombatBtn = document.getElementById("closeCombatBtn");

    toggleCombatBtn.onclick = () => {
      combatOverlay.classList.toggle("hidden");
    };

    closeCombatBtn.onclick = () => {
      combatOverlay.classList.add("hidden");
    };


    toggleBtn.onclick = async () => {
      overlay.classList.toggle("hidden");
      await renderEncyclopedia();
    };

    closeBtn.onclick = () => {
      overlay.classList.add("hidden");
    };

    submitBtn.onclick = async () => {
  const submittedSpells = [];

  Object.entries(gameState.spellHands).forEach(
    ([playerId, handState]) => {
  playerId = Number(playerId);


      const selectedIndexes = gameState.selectedSpells[playerId] || [];

if (selectedIndexes.length === 0) return;


      // Collect spells
      selectedIndexes.forEach(index => {
        submittedSpells.push({
          playerId,
          spell: handState.hand[index]
        });
      });

      // REMOVE spells from hand (descending index!)
      selectedIndexes
        .sort((a, b) => b - a)
        .forEach(i => {
          const [spell] = handState.hand.splice(i, 1);
          handState.discard.push(spell);
        });
    }
  );

  submitSpells(submittedSpells);
  renderPartyHP();

  combatOverlay.classList.remove("hidden");
  document.getElementById("nextRoundPanel").classList.remove("hidden");
  combatResults.textContent =
  gameState.lastCombatResult
    ? JSON.stringify(gameState.lastCombatResult, null, 2)
    : "No combat results";

      if (gameState.gameOver) {
        showGameOverScreen(gameState.victory);
      }
      await renderEncyclopedia();

};


    
  nextRoundBtn.onclick = async () => {
    // Hide the combat overlay
    combatOverlay.classList.add("hidden");
    document.getElementById("nextRoundPanel").classList.add("hidden");
  
    await startRound();
    renderRound();
    renderPartyHP();
  };


    function renderRound() {
      roundInfo.textContent =
        `Day ${gameState.day} ‚Äì Encounter ${gameState.encounter}`;


      if (!gameState.currentYokai) {
        clueInfo.textContent = "Yokai not initialized.";
        return;
      }

      clueInfo.innerHTML = `
        Season: ${gameState.currentYokai.season}<br>
        Area: ${gameState.currentYokai.area}<br>
        Time: ${gameState.timeOfDay}<br>
        Weather: ${gameState.currentYokai.weather}
      `;

      renderSpellHands();
    }

  function renderSpellHands() {
    const container = document.getElementById("spellHands");
    container.innerHTML = "";
  
    Object.entries(gameState.spellHands).forEach(
      ([playerId, handState]) => {
        playerId = Number(playerId);
  
        const selected =
          gameState.selectedSpells[playerId] ??= [];
  
        const spellListHTML = handState.hand
          .map((spell, index) => {
            const isSelected = selected.includes(index);
  
            return `
              <li>
                <button
                  class="spell-btn"
                  data-player="${playerId}"
                  data-index="${index}"
                  ${isSelected ? "disabled" : ""}
                >
                  ${spell.name} (${spell.dice})
                </button>
              </li>
            `;
          })
          .join("");
  
        const div = document.createElement("div");
        div.innerHTML = `
          <strong>Player ${playerId + 1}</strong>
          <ul>${spellListHTML}</ul>
        `;
  
        container.appendChild(div);
      }
    );
  
    document.querySelectorAll(".spell-btn").forEach(btn => {
      btn.onclick = () => {
        const playerId = Number(btn.dataset.player);
        const index = Number(btn.dataset.index);
        selectSpell(playerId, index);
      };
    });
  }


  function selectSpell(playerId, spellIndex) {
    const selected =
    gameState.selectedSpells[playerId] ??= [];
  
    if (selected.length >= 3) return;
    if (selected.includes(spellIndex)) return;
  
    selected.push(spellIndex);
    renderSpellHands();
  }
  
    function renderPartyHP() {
      document.getElementById("partyHP").textContent =
        `${gameState.partyHP} / ${gameState.maxPartyHP}`;
  }

  function renderShop() {
    const shopSpells = getShopSpells();
    const container = document.getElementById("shopSpells");
    const resourceDiv = document.getElementById("shopResources");
  
    resourceDiv.innerHTML = `
      <strong>Resources:</strong><br>
      Fire: ${gameState.resources.Fire} |
      Ice: ${gameState.resources.Ice} |
      Lightning: ${gameState.resources.Lightning} |
      Wind: ${gameState.resources.Wind} |
      Skin: ${gameState.resources.Skin}
      <hr>
    `;
  
    container.innerHTML = shopSpells.map(spell => {
      const costText = Object.entries(spell.cost)
        .map(([res, val]) => `${res}: ${val}`)
        .join(", ");
  
      return `
        <div>
          <strong>${spell.name}</strong> (${spell.dice})
          <br>Cost: ${costText}
          <br>
          <button data-buy="${spell.name}">
            Purchase
          </button>
          <hr>
        </div>
      `;
    }).join("");
  
    document.querySelectorAll("[data-buy]").forEach(btn => {
      btn.onclick = () => buySpell(btn.dataset.buy);
    });
  }

  function buySpell(spellName) {
    const shopSpells = getShopSpells();
    const spell = shopSpells.find(s => s.name === spellName);
  
    if (!spell) return;
  
    // Check resources
    for (const [res, cost] of Object.entries(spell.cost)) {
      if (gameState.resources[res] < cost) {
        alert("Not enough resources!");
        return;
      }
    }
  
    // Deduct resources
    for (const [res, cost] of Object.entries(spell.cost)) {
      gameState.resources[res] -= cost;
    }
  
    // Add spell to ALL players of matching element
    gameState.players.forEach(player => {
      if (player.element === spell.element) {
        gameState.spellHands[player.id].discard.push({ ...spell });
      }
    });
  
    renderShop();
  }

  
  function showGameOverScreen(victory) {
    gamePanel.classList.add("hidden");
  
    const panel = document.getElementById("gameOverPanel");
    const title = document.getElementById("gameOverTitle");
    const text = document.getElementById("gameOverText");
  
    title.textContent = victory
      ? "Victory ‚Äì The Yokai have been sealed!"
      : "Defeat ‚Äì The Onmyoji have fallen‚Ä¶";
  
    text.textContent = victory
      ? "Through teamwork and mastery of the elements, the Yokai have been defeated."
      : "The Yokai overwhelm the capital. Darkness spreads once more.";
  
    panel.classList.remove("hidden");
  }


  document.getElementById("restartGameBtn").onclick = () => {
    // Hide game UI
    gamePanel.classList.add("hidden");
  
    // Show difficulty selection again
    difficultyPanel.classList.remove("hidden");
  
    // Hide overlays/panels
    document.getElementById("gameOverPanel").classList.add("hidden");
    document.getElementById("combatOverlay").classList.add("hidden");
    document.getElementById("encyclopediaOverlay").classList.add("hidden");
  
    // Optional: clear combat text
    document.getElementById("combatResults").textContent = "";
  };

    document
      .querySelectorAll("[data-guardian]")
      .forEach(btn => {
    btn.onclick = async () => {
      const name = btn.dataset.guardian;

      applyGuardian(name);

      document.getElementById("guardianPanel")
        .classList.add("hidden");
      
      gameState.guardianChoicePending = false;
      
      // OPEN SHOP INSTEAD OF ADVANCING DAY
      gameState.shopOpen = true;
      document.getElementById("shopPanel")
        ?.classList.remove("hidden");
      
      renderShop();
    };
  });

    document.getElementById("closeShopBtn").onclick = async () => {

      document.getElementById("shopPanel").classList.add("hidden");
      gameState.shopOpen = false;
    
      advanceDay();
    
      if (gameState.day > gameState.maxDays) {
        showGameOverScreen(true);
        return;
      }
    
      await startRound();
      renderRound();
      renderPartyHP();
    };



  </script>

</body>
</html>
